<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - DANISA SHOP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f5f7; --card: #fff; --primary: #007aff; --text: #000;
      --gray: #8e8e93; --border: #d1d1d6; --success: #34c759; --red: #ff3b30;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header {
      background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .logout {
      padding: 8px 16px; background: var(--red); color: white; border: none;
      border-radius: 8px; cursor: pointer; font-weight: 500;
    }
    .auth {
      background: var(--card); padding: 40px; border-radius: 12px; text-align: center;
      max-width: 400px; margin: 100px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .auth h3 { margin-bottom: 20px; font-size: 20px; }
    .auth input {
      width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; margin-bottom: 16px; font-size: 15px;
    }
    .auth-btn {
      width: 100%; padding: 12px; background: var(--primary); color: white;
      border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500;
    }
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 20px;
    }
    .stat {
      background: var(--card); padding: 20px; border-radius: 12px; text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-val { font-size: 32px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
    .stat-label { font-size: 14px; color: var(--gray); }
    .tabs {
      display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto;
    }
    .tab {
      padding: 10px 20px; background: var(--card); border: none; border-radius: 8px;
      cursor: pointer; font-weight: 500; transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tab.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section {
      background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 { font-size: 18px; margin-bottom: 16px; font-weight: 600; }
    .form-box {
      background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;
    }
    .field { margin-bottom: 12px; }
    .field label {
      display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;
      color: var(--gray);
    }
    .field input, .field textarea, .field select {
      width: 100%; padding: 10px; background: white; border: 1px solid var(--border);
      border-radius: 6px; font-size: 14px; font-family: inherit;
    }
    .field textarea { min-height: 80px; resize: vertical; }
    .file-input {
      width: 100%; padding: 10px; background: white; border: 1px solid var(--border);
      border-radius: 6px; cursor: pointer;
    }
    .btn {
      padding: 10px 20px; background: var(--primary); color: white; border: none;
      border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
    }
    .btn:disabled { background: var(--gray); cursor: not-allowed; }
    .list { margin-top: 16px; }
    .item {
      background: var(--bg); padding: 14px; border-radius: 8px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .item-info { flex: 1; }
    .item-name { font-weight: 500; margin-bottom: 4px; }
    .item-meta { font-size: 12px; color: var(--gray); }
    .item-actions { display: flex; gap: 8px; }
    .del-btn {
      background: rgba(255,59,48,0.1); color: var(--red); border: none;
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .edit-btn {
      background: rgba(0,122,255,0.1); color: var(--primary); border: none;
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .order {
      background: var(--card); padding: 16px; border-radius: 8px; margin-bottom: 12px;
      border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .order-head {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    .order-id { font-weight: 600; font-size: 16px; }
    .order-status {
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500;
    }
    .order-status.new { background: rgba(255,204,0,0.2); color: #ff9500; }
    .order-status.completed { background: rgba(52,199,89,0.2); color: var(--success); }
    .order-info {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px; font-size: 14px; margin-bottom: 12px;
    }
    .order-info-item { padding: 10px; background: var(--bg); border-radius: 6px; }
    .order-info-label {
      font-size: 11px; color: var(--gray); font-weight: 500; margin-bottom: 4px;
    }
    .order-items {
      background: var(--bg); padding: 12px; border-radius: 6px; font-size: 13px;
      margin-bottom: 12px;
    }
    .order-item { margin-bottom: 4px; padding: 4px 0; }
    .complete-btn {
      background: var(--success); color: white; border: none; padding: 8px 16px;
      border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
    }
    .msg {
      padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;
    }
    .msg.success { background: rgba(52,199,89,0.2); color: var(--success); }
    .msg.error { background: rgba(255,59,48,0.2); color: var(--red); }
    .loading { text-align: center; padding: 30px; color: var(--gray); }
    .preview-img {
      max-width: 100px; height: 80px; object-fit: cover; border-radius: 6px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>⚙️ Админ-панель</h1>
        <p style="font-size: 12px; margin-top: 4px; color: var(--gray);">DANISA SHOP</p>
      </div>
      <button class="logout" onclick="logout()">Выход</button>
    </div>

    <div class="auth" id="authSection">
      <h3>Вход</h3>
      <input type="password" id="adminPassword" placeholder="Пароль">
      <button class="auth-btn" onclick="login()">Войти</button>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="msg success" id="successMsg"></div>
      <div class="msg error" id="errorMsg"></div>

      <div class="stats" id="stats" style="display: none;">
        <div class="stat">
          <div class="stat-val" id="totalOrders">0</div>
          <div class="stat-label">Заказов</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="totalProducts">0</div>
          <div class="stat-label">Товаров</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="totalRevenue">0₽</div>
          <div class="stat-label">Общая выручка</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('categories')">Категории</button>
        <button class="tab" onclick="showTab('subcategories')">Подкатегории</button>
        <button class="tab" onclick="showTab('products')">Товары</button>
        <button class="tab" onclick="showTab('orders')">Заказы</button>
      </div>

      <div class="tab-content active" id="categoriesTab">
        <div class="section">
          <h2>Категории</h2>
          <div class="form-box">
            <div class="field">
              <label>Название</label>
              <input type="text" id="catName" placeholder="Например: Куртки">
            </div>
            <button class="btn" onclick="createCat()">Добавить</button>
          </div>
          <div class="list" id="catsList"></div>
        </div>
      </div>

      <div class="tab-content" id="subcategoriesTab">
        <div class="section">
          <h2>Подкатегории</h2>
          <div class="form-box">
            <div class="field">
              <label>Категория</label>
              <select id="subCat"><option value="">Выберите...</option></select>
            </div>
            <div class="field">
              <label>Название</label>
              <input type="text" id="subName" placeholder="Например: Stone Island">
            </div>
            <button class="btn" onclick="createSub()">Добавить</button>
          </div>
          <div class="list" id="subsList"></div>
        </div>
      </div>

      <div class="tab-content" id="productsTab">
        <div class="section">
          <h2>Товары</h2>
          <div class="form-box">
            <div class="field">
              <label>Подкатегория</label>
              <select id="prodSub"><option value="">Выберите...</option></select>
            </div>
            <div class="field">
              <label>Название</label>
              <input type="text" id="prodName" placeholder="Название товара">
            </div>
            <div class="field">
              <label>Описание</label>
              <textarea id="prodDesc" placeholder="Описание..."></textarea>
            </div>
            <div class="field">
              <label>Цена (₽)</label>
              <input type="number" id="prodPrice" placeholder="0" min="0" step="0.01">
            </div>
            <div class="field">
              <label>Фото товара</label>
              <input type="file" class="file-input" id="prodImage" accept="image/*" onchange="previewImage(this)">
              <img id="imagePreview" class="preview-img" style="display: none;">
            </div>
            <button class="btn" onclick="createProd()">Добавить товар</button>
          </div>
          <div class="list" id="prodsList"></div>
        </div>
      </div>

      <div class="tab-content" id="ordersTab">
        <div class="section">
          <h2>Новые заказы</h2>
          <div id="newOrdersList"><div class="loading">Загрузка...</div></div>
        </div>
        <div class="section">
          <h2>История заказов</h2>
          <div id="completedOrdersList"><div class="loading">Загрузка...</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminPassword=null,cats=[],subs=[],prods=[],allOrders=[],uploadedImageData=null;
    if(localStorage.getItem('isAdmin')==='true'){showMain();}
    function login(){const p=document.getElementById('adminPassword').value;if(!p){showError('Введите пароль');return;}adminPassword=p;localStorage.setItem('adminPassword',p);localStorage.setItem('isAdmin','true');document.getElementById('adminPassword').value='';showMain();}
    function logout(){adminPassword=null;localStorage.removeItem('adminPassword');localStorage.removeItem('isAdmin');document.getElementById('authSection').style.display='block';document.getElementById('mainContent').style.display='none';}
    function showMain(){document.getElementById('authSection').style.display='none';document.getElementById('mainContent').style.display='block';adminPassword=localStorage.getItem('adminPassword');loadAll();}
    async function loadAll(){try{const[catsRes,prodsRes,ordersRes]=await Promise.all([fetch('/api/categories'),fetch('/api/products'),fetch(`/api/orders?password=${adminPassword}`)]);cats=await catsRes.json();prods=await prodsRes.json();allOrders=await ordersRes.json();subs=[];for(const c of cats){const r=await fetch(`/api/subcategories/${c.id}`);const d=await r.json();subs.push(...d);}renderCats();renderSubs();renderProds();renderOrders();updateStats();}catch(e){showError('Ошибка загрузки');}}
    function updateStats(){const newOrders=allOrders.filter(o=>o.status==='new');document.getElementById('totalOrders').textContent=newOrders.length||0;document.getElementById('totalProducts').textContent=prods.length||0;const rev=allOrders.reduce((s,o)=>s+(o.total_price||0),0)||0;document.getElementById('totalRevenue').textContent=`${rev}₽`;document.getElementById('stats').style.display='grid';}
    function previewImage(input){if(input.files&&input.files[0]){const reader=new FileReader();reader.onload=function(e){uploadedImageData=e.target.result;document.getElementById('imagePreview').src=e.target.result;document.getElementById('imagePreview').style.display='block';};reader.readAsDataURL(input.files[0]);}}
    async function createCat(){const n=document.getElementById('catName').value.trim();if(!n){showError('Введите название');return;}try{const r=await fetch('/api/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,password:adminPassword})});if(r.ok){document.getElementById('catName').value='';showSuccess('Добавлено');loadAll();}}catch(e){showError('Ошибка');}}
    function renderCats(){const e=document.getElementById('catsList');if(cats.length===0){e.innerHTML='<div class="loading">Нет категорий</div>';return;}e.innerHTML=cats.map(c=>`<div class="item"><div class="item-info"><div class="item-name">${c.name}</div></div><div class="item-actions"><button class="del-btn" onclick="delCat(${c.id})">Удалить</button></div></div>`).join('');const s=document.getElementById('subCat');s.innerHTML='<option value="">Выберите...</option>'+cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');}
    async function delCat(id){if(!confirm('Удалить?'))return;try{const r=await fetch(`/api/categories/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:adminPassword})});if(r.ok){showSuccess('Удалено');loadAll();}}catch(e){}}
    async function createSub(){const cId=document.getElementById('subCat').value,n=document.getElementById('subName').value.trim();if(!cId||!n){showError('Заполните все поля');return;}try{const r=await fetch('/api/subcategories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({categoryId:cId,name:n,password:adminPassword})});if(r.ok){document.getElementById('subName').value='';showSuccess('Добавлено');loadAll();}}catch(e){showError('Ошибка');}}
    function renderSubs(){const e=document.getElementById('subsList');if(subs.length===0){e.innerHTML='<div class="loading">Нет подкатегорий</div>';return;}e.innerHTML=subs.map(s=>{const c=cats.find(x=>x.id===parseInt(s.category_id));return`<div class="item"><div class="item-info"><div class="item-name">${s.name}</div><div class="item-meta">Категория: ${c?.name||'?'}</div></div><div class="item-actions"><button class="del-btn" onclick="delSub(${s.id})">Удалить</button></div></div>`;}).join('');const sel=document.getElementById('prodSub');sel.innerHTML='<option value="">Выберите...</option>'+subs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');}
    async function delSub(id){if(!confirm('Удалить?'))return;try{const r=await fetch(`/api/subcategories/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:adminPassword})});if(r.ok){showSuccess('Удалено');loadAll();}}catch(e){}}
    async function createProd(){const sId=document.getElementById('prodSub').value,n=document.getElementById('prodName').value.trim(),d=document.getElementById('prodDesc').value.trim(),p=parseFloat(document.getElementById('prodPrice').value);if(!sId||!n||!p){showError('Заполните все поля');return;}try{const r=await fetch('/api/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subcategoryId:sId,name:n,description:d,price:p,password:adminPassword,imageData:uploadedImageData})});if(r.ok){document.getElementById('prodName').value='';document.getElementById('prodDesc').value='';document.getElementById('prodPrice').value='';document.getElementById('prodImage').value='';document.getElementById('imagePreview').style.display='none';uploadedImageData=null;showSuccess('Добавлено');loadAll();}}catch(e){showError('Ошибка');}}
    function renderProds(){const e=document.getElementById('prodsList');if(prods.length===0){e.innerHTML='<div class="loading">Нет товаров</div>';return;}e.innerHTML=prods.map(p=>{const s=subs.find(x=>x.id===parseInt(p.subcategory_id));return`<div class="item"><div class="item-info"><div class="item-name">${p.name}</div><div class="item-meta">${s?.name||'?'} • ${p.price}₽</div>${p.main_image?`<img src="${p.main_image}" class="preview-img">`:''}</div><div class="item-actions"><button class="del-btn" onclick="delProd(${p.id})">Удалить</button></div></div>`;}).join('');}
    async function delProd(id){if(!confirm('Удалить?'))return;try{const r=await fetch(`/api/products/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:adminPassword})});if(r.ok){showSuccess('Удалено');loadAll();}}catch(e){}}
    function renderOrders(){const newEl=document.getElementById('newOrdersList'),compEl=document.getElementById('completedOrdersList');const newOrders=allOrders.filter(o=>o.status==='new'),completedOrders=allOrders.filter(o=>o.status==='completed');if(newOrders.length===0)newEl.innerHTML='<div class="loading">Нет новых заказов</div>';else newEl.innerHTML=newOrders.map(o=>renderOrder(o,true)).join('');if(completedOrders.length===0)compEl.innerHTML='<div class="loading">История пуста</div>';else compEl.innerHTML=completedOrders.map(o=>renderOrder(o,false)).join('');}
    function renderOrder(o,showBtn){return`<div class="order"><div class="order-head"><span class="order-id">Заказ #${o.id}</span><span class="order-status ${o.status}">${o.status==='new'?'Новый':'Завершён'}</span></div><div class="order-info"><div class="order-info-item"><div class="order-info-label">Пользователь</div><strong>@${o.username}</strong></div><div class="order-info-item"><div class="order-info-label">Контакт</div><strong>${o.contact}</strong></div><div class="order-info-item"><div class="order-info-label">Сумма</div><strong>${o.total_price}₽</strong></div></div><div class="order-items"><strong>Товары:</strong>${renderOrderItems(o.items)}</div><div style="font-size: 11px; color: var(--gray); margin-top: 8px;">${new Date(o.created_at).toLocaleString('ru-RU')}</div>${showBtn?`<button class="complete-btn" onclick="completeOrder(${o.id})">Завершить заказ</button>`:''}</div>`;}
    function renderOrderItems(items){try{if(typeof items==='string')items=JSON.parse(items);if(Array.isArray(items))return items.map((x,i)=>`<div class="order-item">${i+1}. ${x.name} x${x.quantity} = ${x.price*x.quantity}₽</div>`).join('');return'<div class="order-item">Нет товаров</div>';}catch{return'<div class="order-item">Ошибка</div>';}}
    async function completeOrder(id){if(!confirm('Завершить заказ?'))return;try{const r=await fetch(`/api/orders/${id}/complete`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:adminPassword})});if(r.ok){showSuccess('Заказ завершён');loadAll();}}catch(e){showError('Ошибка');}}
    function showTab(t){document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));document.getElementById(t+'Tab').classList.add('active');document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');if(t==='orders')loadAll();}
    function showSuccess(m){const e=document.getElementById('successMsg');e.textContent=m;e.style.display='block';setTimeout(()=>{e.style.display='none';},3000);}
    function showError(m){const e=document.getElementById('errorMsg');e.textContent=m;e.style.display='block';setTimeout(()=>{e.style.display='none';},3000);}
  </script>
</body>
</html>