<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - DANISA SHOP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #000; --card: #1a1a1a; --accent: #ff3b3b; --text: #fff;
      --gray: #666; --success: #4caf50; --border: #333;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--card), #000);
      padding: 24px; border-radius: 16px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid var(--border);
    }

    .header h1 { font-size: 26px; letter-spacing: 0.5px; }

    .logout {
      padding: 10px 20px; background: rgba(255,59,59,0.2); color: var(--accent);
      border: 1px solid var(--accent); border-radius: 10px; cursor: pointer;
      font-weight: 600; transition: all 0.3s;
    }

    .logout:hover { background: var(--accent); color: #fff; }

    /* Auth */
    .auth {
      background: var(--card); padding: 40px; border-radius: 16px;
      text-align: center; max-width: 400px; margin: 100px auto;
      border: 1px solid var(--border);
    }

    .auth h3 { margin-bottom: 20px; font-size: 22px; }

    .auth input {
      width: 100%; padding: 12px 16px; background: #0a0a0a;
      border: 1px solid var(--border); border-radius: 10px; margin-bottom: 16px;
      font-size: 15px; color: var(--text);
    }

    .auth input:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255,59,59,0.1);
    }

    .auth-btn {
      width: 100%; padding: 12px; background: var(--accent); color: #fff;
      border: none; border-radius: 10px; cursor: pointer; font-size: 15px;
      font-weight: 600; transition: all 0.3s;
    }

    .auth-btn:hover {
      box-shadow: 0 6px 20px rgba(255,59,59,0.4); transform: translateY(-2px);
    }

    /* Stats */
    .stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 24px;
    }

    .stat {
      background: var(--card); padding: 24px; border-radius: 14px;
      text-align: center; border: 1px solid var(--border);
    }

    .stat-val {
      font-size: 36px; font-weight: 700; color: var(--accent); margin-bottom: 8px;
    }

    .stat-label { font-size: 14px; color: var(--gray); }

    /* Tabs */
    .tabs {
      display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px; background: var(--card); border: 2px solid var(--border);
      border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s;
    }

    .tab.active {
      background: var(--accent); border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(255,59,59,0.4);
    }

    .tab:hover { border-color: var(--accent); }

    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .section {
      background: var(--card); padding: 24px; border-radius: 14px;
      margin-bottom: 16px; border: 1px solid var(--border);
    }

    .section h2 { font-size: 20px; margin-bottom: 20px; }

    .form-box {
      background: #0a0a0a; padding: 20px; border-radius: 12px; margin-bottom: 20px;
    }

    .field {
      margin-bottom: 16px;
    }

    .field label {
      display: block; font-size: 13px; font-weight: 600;
      margin-bottom: 7px; color: var(--gray);
    }

    .field input, .field textarea, .field select {
      width: 100%; padding: 11px 14px; background: var(--card);
      border: 1px solid var(--border); border-radius: 9px; font-size: 14px;
      color: var(--text); font-family: inherit;
    }

    .field input:focus, .field textarea:focus, .field select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255,59,59,0.1);
    }

    .field textarea {
      min-height: 80px; resize: vertical;
    }

    .btn {
      padding: 12px 24px; background: var(--accent); color: #fff;
      border: none; border-radius: 10px; cursor: pointer; font-size: 14px;
      font-weight: 600; transition: all 0.3s;
    }

    .btn:hover {
      box-shadow: 0 6px 20px rgba(255,59,59,0.4); transform: translateY(-2px);
    }

    .btn:disabled {
      background: var(--gray); cursor: not-allowed; transform: none;
    }

    /* List */
    .list { margin-top: 20px; }

    .item {
      background: #0a0a0a; padding: 16px; border-radius: 10px;
      margin-bottom: 10px; display: flex; justify-content: space-between;
      align-items: center; border: 1px solid var(--border);
    }

    .item-info { flex: 1; }

    .item-name { font-weight: 600; margin-bottom: 5px; }

    .item-meta { font-size: 12px; color: var(--gray); }

    .item-actions { display: flex; gap: 8px; }

    .del-btn {
      background: rgba(255,59,59,0.2); color: var(--accent);
      border: none; padding: 7px 12px; border-radius: 7px;
      cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s;
    }

    .del-btn:hover { background: var(--accent); color: #fff; }

    .edit-btn {
      background: rgba(33,150,243,0.2); color: #2196F3;
      border: none; padding: 7px 12px; border-radius: 7px;
      cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s;
    }

    .edit-btn:hover { background: #2196F3; color: #fff; }

    /* Orders */
    .order {
      background: var(--card); padding: 18px; border-radius: 12px;
      margin-bottom: 12px; border-left: 4px solid var(--accent);
      border: 1px solid var(--border); border-left-width: 4px;
    }

    .order-head {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }

    .order-id { font-weight: 700; font-size: 17px; }

    .order-status {
      background: var(--success); color: #fff; padding: 4px 10px;
      border-radius: 6px; font-size: 12px; font-weight: 600;
    }

    .order-info {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px; font-size: 14px; margin-bottom: 12px;
    }

    .order-info-item {
      padding: 10px; background: #0a0a0a; border-radius: 7px;
    }

    .order-info-label {
      font-size: 11px; color: var(--gray); font-weight: 600; margin-bottom: 4px;
    }

    .order-items {
      background: #0a0a0a; padding: 12px; border-radius: 7px; font-size: 13px;
    }

    .order-item {
      margin-bottom: 5px; padding: 5px 0;
    }

    .msg {
      padding: 14px; border-radius: 10px; margin-bottom: 20px;
      display: none; animation: fadeIn 0.3s;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .msg.success { background: rgba(76,175,80,0.2); color: var(--success); border: 1px solid var(--success); }
    .msg.error { background: rgba(255,59,59,0.2); color: var(--accent); border: 1px solid var(--accent); }

    .loading { text-align: center; padding: 30px; color: var(--gray); }

    @media (max-width: 768px) {
      .order-info { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>⚙️ Админ-панель</h1>
        <p style="font-size: 12px; margin-top: 5px; color: var(--gray);">DANISA SHOP</p>
      </div>
      <button class="logout" onclick="logout()">Выход</button>
    </div>

    <div class="auth" id="authSection">
      <h3>Вход</h3>
      <input type="password" id="adminPassword" placeholder="Пароль">
      <button class="auth-btn" onclick="login()">Войти</button>
    </div>

    <div id="mainContent" style="display: none;">
      <div class="msg success" id="successMsg"></div>
      <div class="msg error" id="errorMsg"></div>

      <div class="stats" id="stats" style="display: none;">
        <div class="stat">
          <div class="stat-val" id="totalOrders">0</div>
          <div class="stat-label">Заказов</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="totalProducts">0</div>
          <div class="stat-label">Товаров</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="totalRevenue">0₽</div>
          <div class="stat-label">Выручка</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('categories')">Категории</button>
        <button class="tab" onclick="showTab('subcategories')">Подкатегории</button>
        <button class="tab" onclick="showTab('products')">Товары</button>
        <button class="tab" onclick="showTab('orders')">Заказы</button>
      </div>

      <div class="tab-content active" id="categoriesTab">
        <div class="section">
          <h2>Категории</h2>
          <div class="form-box">
            <div class="field">
              <label>Название</label>
              <input type="text" id="catName" placeholder="Например: Куртки">
            </div>
            <button class="btn" onclick="createCat()">Добавить</button>
          </div>
          <div class="list" id="catsList"></div>
        </div>
      </div>

      <div class="tab-content" id="subcategoriesTab">
        <div class="section">
          <h2>Подкатегории</h2>
          <div class="form-box">
            <div class="field">
              <label>Категория</label>
              <select id="subCat">
                <option value="">Выберите...</option>
              </select>
            </div>
            <div class="field">
              <label>Название</label>
              <input type="text" id="subName" placeholder="Например: Stone Island">
            </div>
            <button class="btn" onclick="createSub()">Добавить</button>
          </div>
          <div class="list" id="subsList"></div>
        </div>
      </div>

      <div class="tab-content" id="productsTab">
        <div class="section">
          <h2>Товары</h2>
          <div class="form-box">
            <div class="field">
              <label>Подкатегория</label>
              <select id="prodSub">
                <option value="">Выберите...</option>
              </select>
            </div>
            <div class="field">
              <label>Название</label>
              <input type="text" id="prodName" placeholder="Название товара">
            </div>
            <div class="field">
              <label>Описание</label>
              <textarea id="prodDesc" placeholder="Описание..."></textarea>
            </div>
            <div class="field">
              <label>Цена (₽)</label>
              <input type="number" id="prodPrice" placeholder="0" min="0" step="0.01">
            </div>
            <button class="btn" onclick="createProd()">Добавить</button>
          </div>
          <div class="list" id="prodsList"></div>
        </div>
      </div>

      <div class="tab-content" id="ordersTab">
        <div class="section">
          <h2>Заказы</h2>
          <div id="ordersList">
            <div class="loading">Загрузка...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminPassword = null;
    let cats = [];
    let subs = [];
    let prods = [];

    if (localStorage.getItem('isAdmin') === 'true') {
      showMain();
    }

    function login() {
      const pwd = document.getElementById('adminPassword').value;
      if (!pwd) {
        showError('Введите пароль');
        return;
      }
      adminPassword = pwd;
      localStorage.setItem('adminPassword', pwd);
      localStorage.setItem('isAdmin', 'true');
      document.getElementById('adminPassword').value = '';
      showMain();
    }

    function logout() {
      adminPassword = null;
      localStorage.removeItem('adminPassword');
      localStorage.removeItem('isAdmin');
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
    }

    function showMain() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      adminPassword = localStorage.getItem('adminPassword');
      loadAll();
    }

    async function loadAll() {
      try {
        const [catsRes, prodsRes, ordersRes] = await Promise.all([
          fetch('/api/categories'),
          fetch('/api/products'),
          fetch(`/api/orders?password=${adminPassword}`)
        ]);

        cats = await catsRes.json();
        prods = await prodsRes.json();

        subs = [];
        for (const cat of cats) {
          const res = await fetch(`/api/subcategories/${cat.id}`);
          const data = await res.json();
          subs.push(...data);
        }

        const orders = await ordersRes.json();

        renderCats();
        renderSubs();
        renderProds();
        renderOrders(orders);
        updateStats(orders);
      } catch (e) {
        showError('Ошибка загрузки');
      }
    }

    function updateStats(orders) {
      document.getElementById('totalOrders').textContent = orders.length || 0;
      document.getElementById('totalProducts').textContent = prods.length || 0;
      const rev = orders.reduce((s, o) => s + (o.total_price || 0), 0) || 0;
      document.getElementById('totalRevenue').textContent = `${rev}₽`;
      document.getElementById('stats').style.display = 'grid';
    }

    async function createCat() {
      const name = document.getElementById('catName').value.trim();
      if (!name) {
        showError('Введите название');
        return;
      }

      try {
        const res = await fetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, password: adminPassword })
        });

        if (res.ok) {
          document.getElementById('catName').value = '';
          showSuccess('Добавлено');
          loadAll();
        } else {
          showError('Ошибка');
        }
      } catch (e) {
        showError('Ошибка');
      }
    }

    function renderCats() {
      const el = document.getElementById('catsList');
      if (cats.length === 0) {
        el.innerHTML = '<div class="loading">Нет категорий</div>';
        return;
      }

      el.innerHTML = cats.map(c => `
        <div class="item">
          <div class="item-info">
            <div class="item-name">${c.name}</div>
          </div>
          <div class="item-actions">
            <button class="del-btn" onclick="delCat(${c.id})">Удалить</button>
          </div>
        </div>
      `).join('');

      const sel = document.getElementById('subCat');
      sel.innerHTML = '<option value="">Выберите...</option>' +
        cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function delCat(id) {
      if (!confirm('Удалить?')) return;

      try {
        const res = await fetch(`/api/categories/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: adminPassword })
        });

        if (res.ok) {
          showSuccess('Удалено');
          loadAll();
        }
      } catch (e) {}
    }

    async function createSub() {
      const catId = document.getElementById('subCat').value;
      const name = document.getElementById('subName').value.trim();

      if (!catId || !name) {
        showError('Заполните все поля');
        return;
      }

      try {
        const res = await fetch('/api/subcategories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categoryId: catId, name, password: adminPassword })
        });

        if (res.ok) {
          document.getElementById('subName').value = '';
          showSuccess('Добавлено');
          loadAll();
        }
      } catch (e) {
        showError('Ошибка');
      }
    }

    function renderSubs() {
      const el = document.getElementById('subsList');
      if (subs.length === 0) {
        el.innerHTML = '<div class="loading">Нет подкатегорий</div>';
        return;
      }

      el.innerHTML = subs.map(s => {
        const cat = cats.find(c => c.id === parseInt(s.category_id));
        return `
          <div class="item">
            <div class="item-info">
              <div class="item-name">${s.name}</div>
              <div class="item-meta">Категория: ${cat?.name || '?'}</div>
            </div>
            <div class="item-actions">
              <button class="del-btn" onclick="delSub(${s.id})">Удалить</button>
            </div>
          </div>
        `;
      }).join('');

      const sel = document.getElementById('prodSub');
      sel.innerHTML = '<option value="">Выберите...</option>' +
        subs.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    async function delSub(id) {
      if (!confirm('Удалить?')) return;

      try {
        const res = await fetch(`/api/subcategories/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: adminPassword })
        });

        if (res.ok) {
          showSuccess('Удалено');
          loadAll();
        }
      } catch (e) {}
    }

    async function createProd() {
      const subId = document.getElementById('prodSub').value;
      const name = document.getElementById('prodName').value.trim();
      const desc = document.getElementById('prodDesc').value.trim();
      const price = parseFloat(document.getElementById('prodPrice').value);

      if (!subId || !name || !price) {
        showError('Заполните все поля');
        return;
      }

      try {
        const res = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subcategoryId: subId, name, description: desc, price, password: adminPassword })
        });

        if (res.ok) {
          document.getElementById('prodName').value = '';
          document.getElementById('prodDesc').value = '';
          document.getElementById('prodPrice').value = '';
          showSuccess('Добавлено');
          loadAll();
        }
      } catch (e) {
        showError('Ошибка');
      }
    }

    function renderProds() {
      const el = document.getElementById('prodsList');
      if (prods.length === 0) {
        el.innerHTML = '<div class="loading">Нет товаров</div>';
        return;
      }

      el.innerHTML = prods.map(p => {
        const sub = subs.find(s => s.id === parseInt(p.subcategory_id));
        return `
          <div class="item">
            <div class="item-info">
              <div class="item-name">${p.name}</div>
              <div class="item-meta">${sub?.name || '?'} • ${p.price}₽</div>
              ${p.main_image ? `<div style="margin-top: 8px;"><img src="${p.main_image}" style="max-width: 80px; height: 60px; object-fit: cover; border-radius: 6px;"></div>` : ''}
            </div>
            <div class="item-actions">
              <button class="edit-btn" onclick="editProd(${p.id})">Фото</button>
              <button class="del-btn" onclick="delProd(${p.id})">Удалить</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function editProd(id) {
      const url = prompt('Введите URL изображения:');
      if (!url) return;

      const p = prods.find(x => x.id === id);
      if (!p) return;

      if (!p.images) p.images = [];
      p.images.push(url);
      if (!p.main_image) p.main_image = url;

      showSuccess('Добавлено (временно в памяти)');
      renderProds();
    }

    async function delProd(id) {
      if (!confirm('Удалить?')) return;

      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: adminPassword })
        });

        if (res.ok) {
          showSuccess('Удалено');
          loadAll();
        }
      } catch (e) {}
    }

    function renderOrders(orders) {
      const el = document.getElementById('ordersList');

      if (!orders || orders.length === 0) {
        el.innerHTML = '<div class="loading">Нет заказов</div>';
        return;
      }

      el.innerHTML = orders.map(o => `
        <div class="order">
          <div class="order-head">
            <span class="order-id">Заказ #${o.id}</span>
            <span class="order-status">${o.status}</span>
          </div>
          <div class="order-info">
            <div class="order-info-item">
              <div class="order-info-label">Пользователь</div>
              <strong>@${o.username}</strong>
            </div>
            <div class="order-info-item">
              <div class="order-info-label">Контакт</div>
              <strong>${o.contact}</strong>
            </div>
            <div class="order-info-item">
              <div class="order-info-label">Сумма</div>
              <strong>${o.total_price}₽</strong>
            </div>
          </div>
          <div class="order-items">
            <strong>Товары:</strong>
            ${renderOrderItems(o.items)}
          </div>
          <div style="font-size: 11px; color: var(--gray); margin-top: 10px;">
            ${new Date(o.created_at).toLocaleString('ru-RU')}
          </div>
        </div>
      `).join('');
    }

    function renderOrderItems(items) {
      try {
        if (typeof items === 'string') items = JSON.parse(items);
        if (Array.isArray(items)) {
          return items.map((x, i) => `
            <div class="order-item">
              ${i + 1}. ${x.name} x${x.quantity} = ${x.price * x.quantity}₽
            </div>
          `).join('');
        }
        return '<div class="order-item">Нет товаров</div>';
      } catch {
        return '<div class="order-item">Ошибка</div>';
      }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tab + 'Tab').classList.add('active');

      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'orders') loadAll();
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }
  </script>
</body>
</html>