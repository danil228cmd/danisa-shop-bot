<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DANISA SHOP - –ú–∞–≥–∞–∑–∏–Ω</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #000;
      --secondary: #f5f5f5;
      --accent: #ff6b6b;
      --text: #333;
      --border: #e0e0e0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--secondary);
      color: var(--text);
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    /* HEADER */
    .header {
      background: var(--primary);
      color: white;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .cart-icon {
      position: relative;
      cursor: pointer;
      font-size: 24px;
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* FILTERS */
    .filters {
      background: white;
      padding: 16px;
      margin: 16px;
      border-radius: 12px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid var(--border);
      background: white;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .filter-btn:hover {
      border-color: var(--primary);
    }

    /* SORT */
    .sort-section {
      display: flex;
      gap: 8px;
      padding: 0 16px;
      margin-bottom: 16px;
    }

    .sort-btn {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .sort-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* PRODUCTS GRID */
    .products {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 12px;
      margin: 0 4px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }

    .product-image {
      width: 100%;
      aspect-ratio: 1;
      background: var(--secondary);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-info {
      padding: 12px;
    }

    .product-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.3;
      height: 2.6em;
      overflow: hidden;
    }

    .product-price {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .product-add-btn {
      width: 100%;
      padding: 8px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .product-add-btn:hover {
      background: var(--accent);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 16px;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: flex-end;
    }

    .modal-content {
      background: white;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 20px;
      animation: slideUp 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .modal-close {
      text-align: right;
      margin-bottom: 16px;
    }

    .modal-close button {
      background: var(--secondary);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 16px;
    }

    .carousel {
      width: 100%;
      aspect-ratio: 1;
      background: var(--secondary);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 16px;
    }

    .carousel-image {
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .carousel-image.active img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .carousel-nav {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      cursor: pointer;
    }

    .carousel-dot.active {
      background: white;
    }

    .product-details {
      margin-bottom: 16px;
    }

    .product-details h2 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .product-details p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .product-price-large {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .quantity-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      background: var(--secondary);
      padding: 12px;
      border-radius: 8px;
    }

    .qty-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }

    .qty-display {
      flex: 1;
      text-align: center;
      font-weight: 600;
    }

    .modal-add-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .modal-add-btn:hover {
      background: var(--accent);
    }

    /* CART */
    .cart-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      padding: 16px;
      overflow-y: auto;
    }

    .cart-modal.active {
      display: flex;
      align-items: flex-end;
    }

    .cart-content {
      background: white;
      width: 100%;
      border-radius: 24px 24px 0 0;
      padding: 20px;
      animation: slideUp 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .cart-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--secondary);
      border-radius: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .cart-item-image {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .cart-item-price {
      font-size: 12px;
      color: #666;
    }

    .cart-item-remove {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .cart-empty {
      text-align: center;
      padding: 32px 16px;
      color: #999;
    }

    .cart-summary {
      border-top: 2px solid var(--border);
      padding: 16px 0;
      margin-bottom: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .summary-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .checkout-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .checkout-btn:hover {
      background: var(--accent);
    }

    .checkout-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .checkout-form {
      display: none;
      margin-top: 16px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }

    .success-message {
      background: #4caf50;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
    }

    .error-message {
      background: #f44336;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
    }

    @media (max-width: 480px) {
      .products {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>üõçÔ∏è DANISA SHOP</h1>
      <div class="cart-icon" onclick="openCart()">
        üõí
        <div class="cart-badge" id="cartBadge" style="display: none;">0</div>
      </div>
    </div>

    <!-- FILTERS & SORT -->
    <div class="filters" id="filters">
      <button class="filter-btn active" onclick="filterByCategory(null)">–í—Å–µ</button>
    </div>

    <div class="sort-section">
      <button class="sort-btn active" onclick="sortProducts('default')">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</button>
      <button class="sort-btn" onclick="sortProducts('price-asc')">–¶–µ–Ω–∞ ‚Üë</button>
      <button class="sort-btn" onclick="sortProducts('price-desc')">–¶–µ–Ω–∞ ‚Üì</button>
      <button class="sort-btn" onclick="sortProducts('name')">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</button>
    </div>

    <!-- PRODUCTS GRID -->
    <div class="products" id="products">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
    </div>
  </div>

  <!-- PRODUCT DETAIL MODAL -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-close">
        <button onclick="closeModal()">‚úï</button>
      </div>
      <div class="carousel" id="carousel">
        <div class="carousel-image active" id="carouselImage0">
          <img src="" alt="product">
        </div>
        <div class="carousel-nav" id="carouselNav"></div>
      </div>
      <div class="product-details">
        <h2 id="modalProductName"></h2>
        <div class="product-price-large" id="modalProductPrice"></div>
        <p id="modalProductDescription"></p>
      </div>
      <div class="quantity-selector">
        <button class="qty-btn" onclick="changeQuantity(-1)">‚àí</button>
        <div class="qty-display" id="quantityDisplay">1</div>
        <button class="qty-btn" onclick="changeQuantity(1)">+</button>
      </div>
      <button class="modal-add-btn" onclick="addToCart()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="cart-modal" id="cartModal">
    <div class="cart-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <button onclick="closeCart()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
      </div>

      <div class="cart-items" id="cartItems">
        <div class="cart-empty">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      </div>

      <div id="cartSummarySection" style="display: none;">
        <div class="cart-summary">
          <div class="summary-row">
            <span>–°—É–º–º–∞:</span>
            <span id="cartSubtotal">0‚ÇΩ</span>
          </div>
          <div class="summary-row" style="font-size: 16px; font-weight: 700; color: var(--accent);">
            <span>–ò—Ç–æ–≥–æ:</span>
            <span id="cartTotal">0‚ÇΩ</span>
          </div>
        </div>

        <button class="checkout-btn" onclick="startCheckout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>

        <div class="checkout-form" id="checkoutForm">
          <div class="form-group">
            <label>–í–∞—à–µ –∏–º—è / Nickname:</label>
            <input type="text" id="contactName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
          </div>
          <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏:</label>
            <input type="text" id="contactPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ @username">
          </div>
          <button class="checkout-btn" onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
          <button class="checkout-btn" onclick="cancelCheckout()" style="background: #999; margin-top: 8px;">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let WebApp = window.Telegram?.WebApp;
    let currentUser = null;
    let allProducts = [];
    let allCategories = [];
    let allSubcategories = [];
    let cart = [];
    let currentProductId = null;
    let currentQuantity = 1;
    let currentSortBy = 'default';
    let currentFilterCategory = null;

    // Initialize Web App
    if (WebApp) {
      WebApp.ready();
      WebApp.expand();
      currentUser = WebApp.initData ? new URLSearchParams(WebApp.initData).get('user') : null;
      if (currentUser) {
        currentUser = JSON.parse(atob(currentUser.split('.')[1]));
      }
    }

    // Simulate user if not in Telegram
    if (!currentUser) {
      currentUser = {
        id: Math.floor(Math.random() * 1000000),
        first_name: 'Test',
        username: 'testuser'
      };
    }

    // Load data
    async function loadData() {
      try {
        const [categoriesRes, productsRes] = await Promise.all([
          fetch('/api/categories'),
          fetch('/api/products')
        ]);

        allCategories = await categoriesRes.json();
        allProducts = await productsRes.json();

        loadSubcategories();
        renderFilters();
        renderProducts();
        loadCart();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    async function loadSubcategories() {
      try {
        const subcats = [];
        for (const cat of allCategories) {
          const res = await fetch(`/api/subcategories/${cat.id}`);
          const data = await res.json();
          subcats.push(...data);
        }
        allSubcategories = subcats;
      } catch (error) {
        console.error('Error loading subcategories:', error);
      }
    }

    function renderFilters() {
      const filtersContainer = document.getElementById('filters');
      filtersContainer.innerHTML = '<button class="filter-btn active" onclick="filterByCategory(null)">–í—Å–µ</button>';

      allCategories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = cat.name;
        btn.onclick = () => filterByCategory(cat.id);
        filtersContainer.appendChild(btn);
      });
    }

    function filterByCategory(categoryId) {
      currentFilterCategory = categoryId;
      currentSortBy = 'default';
      renderProducts();
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function sortProducts(sortBy) {
      currentSortBy = sortBy;
      renderProducts();

      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function renderProducts() {
      let filtered = [...allProducts];

      if (currentFilterCategory) {
        const subcatsInCategory = allSubcategories
          .filter(s => s.category_id === currentFilterCategory)
          .map(s => s.id);
        filtered = filtered.filter(p => {
          const subcat = allSubcategories.find(s => s.id === p.subcategory_id);
          return subcatsInCategory.includes(subcat?.id);
        });
      }

      // Sort
      if (currentSortBy === 'price-asc') {
        filtered.sort((a, b) => a.price - b.price);
      } else if (currentSortBy === 'price-desc') {
        filtered.sort((a, b) => b.price - a.price);
      } else if (currentSortBy === 'name') {
        filtered.sort((a, b) => a.name.localeCompare(b.name, 'ru'));
      }

      const container = document.getElementById('products');
      container.innerHTML = filtered.map(product => `
        <div class="product-card" onclick="openProductDetail(${product.id})">
          <div class="product-image">
            ${product.main_image ? `<img src="${product.main_image}" alt="${product.name}">` : '<div style="width: 100%; height: 100%; background: var(--secondary);"></div>'}
          </div>
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-price">${product.price}‚ÇΩ</div>
            <button class="product-add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      `).join('');
    }

    async function openProductDetail(productId) {
      try {
        const res = await fetch(`/api/products/${productId}`);
        const product = await res.json();
        
        currentProductId = productId;
        currentQuantity = 1;

        // Setup carousel
        const carouselNav = document.getElementById('carouselNav');
        const carousel = document.getElementById('carousel');
        carouselNav.innerHTML = '';

        if (product.images && product.images.length > 0) {
          carousel.innerHTML = product.images.map((img, idx) => `
            <div class="carousel-image ${idx === 0 ? 'active' : ''}" id="carouselImage${idx}">
              <img src="${img}" alt="product">
            </div>
          `).join('');

          product.images.forEach((_, idx) => {
            const dot = document.createElement('div');
            dot.className = `carousel-dot ${idx === 0 ? 'active' : ''}`;
            dot.onclick = () => switchCarouselImage(idx);
            carouselNav.appendChild(dot);
          });
        } else {
          carousel.innerHTML = '<div class="carousel-image active"><div style="width: 100%; height: 100%; background: var(--secondary);"></div></div>';
        }

        document.getElementById('modalProductName').textContent = product.name;
        document.getElementById('modalProductPrice').textContent = `${product.price}‚ÇΩ`;
        document.getElementById('modalProductDescription').textContent = product.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        document.getElementById('quantityDisplay').textContent = currentQuantity;

        document.getElementById('productModal').classList.add('active');
      } catch (error) {
        console.error('Error loading product:', error);
      }
    }

    function switchCarouselImage(index) {
      document.querySelectorAll('.carousel-image').forEach((img, idx) => {
        img.classList.toggle('active', idx === index);
      });
      document.querySelectorAll('.carousel-dot').forEach((dot, idx) => {
        dot.classList.toggle('active', idx === index);
      });
    }

    function changeQuantity(delta) {
      currentQuantity = Math.max(1, currentQuantity + delta);
      document.getElementById('quantityDisplay').textContent = currentQuantity;
    }

    function closeModal() {
      document.getElementById('productModal').classList.remove('active');
    }

    async function addToCart() {
      const product = allProducts.find(p => p.id === currentProductId);
      
      const existingItem = cart.find(item => item.id === currentProductId);
      if (existingItem) {
        existingItem.quantity += currentQuantity;
      } else {
        cart.push({
          id: currentProductId,
          name: product.name,
          price: product.price,
          image: product.main_image,
          quantity: currentQuantity
        });
      }

      await saveCart();
      updateCartBadge();
      closeModal();
      
      alert('‚úì –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
    }

    function openCart() {
      renderCart();
      document.getElementById('cartModal').classList.add('active');
    }

    function closeCart() {
      document.getElementById('cartModal').classList.remove('active');
    }

    function renderCart() {
      const cartItemsContainer = document.getElementById('cartItems');
      const summarySection = document.getElementById('cartSummarySection');

      if (cart.length === 0) {
        cartItemsContainer.innerHTML = '<div class="cart-empty">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
        summarySection.style.display = 'none';
      } else {
        cartItemsContainer.innerHTML = cart.map((item, idx) => `
          <div class="cart-item">
            <div class="cart-item-image">
              ${item.image ? `<img src="${item.image}" alt="${item.name}">` : '<div style="width: 100%; height: 100%; background: var(--secondary);"></div>'}
            </div>
            <div class="cart-item-info">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-price">${item.price}‚ÇΩ x${item.quantity}</div>
            </div>
            <button class="cart-item-remove" onclick="removeFromCart(${idx})">‚úï</button>
          </div>
        `).join('');

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('cartSubtotal').textContent = `${total}‚ÇΩ`;
        document.getElementById('cartTotal').textContent = `${total}‚ÇΩ`;
        summarySection.style.display = 'block';
      }
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      saveCart();
      updateCartBadge();
      renderCart();
    }

    function updateCartBadge() {
      const badge = document.getElementById('cartBadge');
      if (cart.length === 0) {
        badge.style.display = 'none';
      } else {
        badge.textContent = cart.length;
        badge.style.display = 'flex';
      }
    }

    async function saveCart() {
      try {
        await fetch(`/api/cart/${currentUser.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cart })
        });
      } catch (error) {
        console.error('Error saving cart:', error);
      }
    }

    async function loadCart() {
      try {
        const res = await fetch(`/api/cart/${currentUser.id}`);
        const data = await res.json();
        cart = data.items || [];
        updateCartBadge();
      } catch (error) {
        console.error('Error loading cart:', error);
      }
    }

    function startCheckout() {
      if (cart.length === 0) return;
      document.getElementById('checkoutForm').style.display = 'block';
    }

    function cancelCheckout() {
      document.getElementById('checkoutForm').style.display = 'none';
    }

    async function submitOrder() {
      const name = document.getElementById('contactName').value.trim();
      const contact = document.getElementById('contactPhone').value.trim();

      if (!name || !contact) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      try {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegramUserId: currentUser.id,
            username: currentUser.username || name,
            contact: contact,
            items: cart,
            totalPrice: total
          })
        });

        const data = await res.json();
        if (data.id) {
          alert('‚úì –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.');
          cart = [];
          saveCart();
          updateCartBadge();
          closeCart();
          document.getElementById('checkoutForm').style.display = 'none';
          document.getElementById('contactName').value = '';
          document.getElementById('contactPhone').value = '';
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
        }
      } catch (error) {
        console.error('Error submitting order:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
      }
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
